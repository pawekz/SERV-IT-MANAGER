name: Docker Image CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Azure MySQL SSL Certificate Exists
        run: test -f ./backend/DigiCertGlobalRootCA.crt.pem

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/servit-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/servit-backend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/servit-backend:latest
          cache-to: type=inline

      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            VITE_API_BASE_URL=https://servit-backendv2-b6arhyfsadg4fbhc.southeastasia-01.azurewebsites.net
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/servit:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/servit:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/servit:latest
          cache-to: type=inline

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend to Web App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            echo "Deploying backend container to Azure Web App..."
            
            # Configure container settings for backend
            az webapp config container set \
              --name servit-backendv2 \
              --resource-group servit \
              --container-image-name ${{ secrets.DOCKERHUB_USERNAME }}/servit-backend:latest \
              --container-registry-url https://index.docker.io/v1/ \
              --container-registry-user ${{ secrets.DOCKERHUB_USERNAME }} \
              --container-registry-password ${{ secrets.DOCKERHUB_TOKEN }}
            
            # Enable continuous deployment
            az webapp deployment container config \
              --name servit-backendv2 \
              --resource-group servit \
              --enable-cd true
            
            # Configure application settings
            az webapp config appsettings set \
              --name servit-backendv2 \
              --resource-group servit \
              --settings \
                MYSQL_DATABASE="${{ secrets.MYSQL_DATABASE }}" \
                MYSQL_USERNAME="${{ secrets.MYSQL_USERNAME }}" \
                MYSQL_PASSWORD="${{ secrets.MYSQL_PASSWORD }}" \
                MYSQL_SERVER="${{ secrets.MYSQL_SERVER }}" \
                WEBSITES_PORT=8080 \
                DOCKER_ENABLE_CI=true
            
            # Restart the web app to apply changes
            az webapp restart --name servit-backendv2 --resource-group servit
            
            # Wait for deployment to complete and verify
            echo "Waiting for backend deployment to complete..."
            sleep 30
            
            # Check deployment status
            STATUS=$(az webapp show --name servit-backendv2 --resource-group servit --query "state" -o tsv)
            echo "Backend deployment status: $STATUS"

      - name: Deploy Frontend to Web App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            echo "Deploying frontend container to Azure Web App..."
            
            # Configure container settings for frontend
            az webapp config container set \
              --name servit \
              --resource-group servit \
              --container-image-name ${{ secrets.DOCKERHUB_USERNAME }}/servit:latest \
              --container-registry-url https://index.docker.io/v1/ \
              --container-registry-user ${{ secrets.DOCKERHUB_USERNAME }} \
              --container-registry-password ${{ secrets.DOCKERHUB_TOKEN }}
            
            # Enable continuous deployment
            az webapp deployment container config \
              --name servit \
              --resource-group servit \
              --enable-cd true
            
            # Configure application settings for frontend (Nginx)
            az webapp config appsettings set \
              --name servit \
              --resource-group servit \
              --settings \
                WEBSITES_PORT=8080 \
                DOCKER_ENABLE_CI=true
            
            # Restart the web app to apply changes
            az webapp restart --name servit --resource-group servit
            
            # Wait for deployment to complete and verify
            echo "Waiting for frontend deployment to complete..."
            sleep 30
            
            # Check deployment status
            STATUS=$(az webapp show --name servit --resource-group servit --query "state" -o tsv)
            echo "Frontend deployment status: $STATUS"

      - name: Verify Deployments
        uses: azure/CLI@v2
        with:
          inlineScript: |
            echo "Verifying deployments..."
            
            # Check backend health
            BACKEND_STATE=$(az webapp show --name servit-backendv2 --resource-group servit --query "state" -o tsv)
            BACKEND_URL=$(az webapp show --name servit-backendv2 --resource-group servit --query "defaultHostName" -o tsv)
            echo "Backend State: $BACKEND_STATE"
            echo "Backend URL: https://$BACKEND_URL"
            
            # Check frontend health
            FRONTEND_STATE=$(az webapp show --name servit --resource-group servit --query "state" -o tsv)
            FRONTEND_URL=$(az webapp show --name servit --resource-group servit --query "defaultHostName" -o tsv)
            echo "Frontend State: $FRONTEND_STATE"
            echo "Frontend URL: https://$FRONTEND_URL"
            
            # Verify both apps are running
            if [ "$BACKEND_STATE" = "Running" ] && [ "$FRONTEND_STATE" = "Running" ]; then
              echo "âœ… Both applications deployed successfully!"
            else
              echo "âŒ Deployment verification failed"
              exit 1
            fi

      - name: Output Deployment URLs
        uses: azure/CLI@v2
        with:
          inlineScript: |
            BACKEND_URL=$(az webapp show --name servit-backendv2 --resource-group servit --query "defaultHostName" -o tsv)
            FRONTEND_URL=$(az webapp show --name servit --resource-group servit --query "defaultHostName" -o tsv)
            
            echo "ðŸš€ Deployment Complete!"
            echo "Backend API: https://$BACKEND_URL"
            echo "Frontend App: https://$FRONTEND_URL"
            
            # Set outputs for potential use in other jobs
            echo "backend_url=https://$BACKEND_URL" >> $GITHUB_OUTPUT
            echo "frontend_url=https://$FRONTEND_URL" >> $GITHUB_OUTPUT
